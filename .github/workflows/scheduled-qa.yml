name: Scheduled QA - Playwright E2E

on:
  # Run every 6 hours
  schedule:
    - cron: '0 */6 * * *'
  # Also run on push to main
  push:
    branches: [main]
  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Start dev server
        run: npm run dev &
        env:
          CI: true

      - name: Wait for server
        run: npx wait-on http://localhost:5173 --timeout 30000

      - name: Run Playwright E2E tests
        id: e2e
        run: npx playwright test --reporter=html
        continue-on-error: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ github.run_number }}
          path: playwright-report/
          retention-days: 30

      - name: Upload screenshots on failure
        uses: actions/upload-artifact@v4
        if: failure() || steps.e2e.outcome == 'failure'
        with:
          name: test-screenshots-${{ github.run_number }}
          path: test-results/
          retention-days: 30

      - name: Create issue on failure
        if: steps.e2e.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            const issueBody = `## ðŸ”´ Scheduled QA Failed

            **Run:** [${process.env.GITHUB_RUN_ID}](${runUrl})
            **Triggered by:** ${process.env.GITHUB_EVENT_NAME}
            **Commit:** ${process.env.GITHUB_SHA.substring(0, 7)}
            **Time:** ${new Date().toISOString()}

            ### Evidence
            - ðŸ“Š [Playwright Report](${runUrl}#artifacts) (artifact: \`playwright-report-${{ github.run_number }}\`)
            - ðŸ“¸ [Screenshots](${runUrl}#artifacts) (artifact: \`test-screenshots-${{ github.run_number }}\`)

            ### Next Steps
            1. Download artifacts from the run
            2. Review the Playwright HTML report
            3. Identify the failing test(s) and root cause
            4. Create a fix following the process in AGENTS.md

            ---
            *This issue was auto-generated by the Scheduled QA workflow.*
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ”´ QA Failed: E2E tests failing (Run #${{ github.run_number }})`,
              body: issueBody,
              labels: ['bug', 'qa-failure', 'needs-investigation']
            });

      - name: Fail if tests failed
        if: steps.e2e.outcome == 'failure'
        run: exit 1
